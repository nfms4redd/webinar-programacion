
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.2, mkdocs-material-1.7.5">
    
    
      
        <title>Servlet de configuración - Curso de programación de NFMS4REDD</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-769c285a91.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../static/exercises/map-scale.css">
    
      <link rel="stylesheet" href="../../static/exercises/new-group-layer.css">
    
      <link rel="stylesheet" href="../../static/exercises/temperature.css">
    
      <link rel="stylesheet" href="../../static/exercises/wfs-query.css">
    
      <link rel="stylesheet" href="../../static/exercises/zoom-panel.css">
    
      <link rel="stylesheet" href="../../static/exercises/zoomto.css">
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../.." title="Curso de programación de NFMS4REDD" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Servidor
                </span>
              
            
            Servlet de configuración
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Curso de programación de NFMS4REDD
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Índice" class="md-nav__link">
      Índice
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../setup/" title="Preparación" class="md-nav__link">
      Preparación
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Cliente
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Cliente
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../client/hello_world/" title="Hola mundo" class="md-nav__link">
      Hola mundo
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../client/add_ui/" title="Añadir elementos a la interfaz" class="md-nav__link">
      Añadir elementos a la interfaz
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../client/reuse/" title="Reutilizar funcionalidad" class="md-nav__link">
      Reutilizar funcionalidad
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../client/events/" title="Manejar eventos" class="md-nav__link">
      Manejar eventos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../client/add_map_functionality/" title="Añadir funcionalidad al mapa" class="md-nav__link">
      Añadir funcionalidad al mapa
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Servidor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Servidor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../hello_world/" title="Hola mundo" class="md-nav__link">
      Hola mundo
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Servlet de configuración
      </label>
    
    <a href="./" title="Servlet de configuración" class="md-nav__link md-nav__link--active">
      Servlet de configuración
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creando-el-proyecto" title="Creando el proyecto" class="md-nav__link">
    Creando el proyecto
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creando-el-servlet" title="Creando el servlet" class="md-nav__link">
    Creando el servlet
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manejando-errores" title="Manejando errores" class="md-nav__link">
    Manejando errores
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../db_servlet/" title="Servlet de acceso a base de datos" class="md-nav__link">
      Servlet de acceso a base de datos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../deploy_considerations/" title="Consideraciones sobre el despliegue" class="md-nav__link">
      Consideraciones sobre el despliegue
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../exercises/" title="Ejercicios" class="md-nav__link">
      Ejercicios
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creando-el-proyecto" title="Creando el proyecto" class="md-nav__link">
    Creando el proyecto
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creando-el-servlet" title="Creando el servlet" class="md-nav__link">
    Creando el servlet
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manejando-errores" title="Manejando errores" class="md-nav__link">
    Manejando errores
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Servlet de configuración</h1>
                
                <p>En este caso vamos a crear un servlet que nos permita modificar el centro en el que se carga el mapa al arrancar.</p>
<p>El centro del mapa se define en las propiedades <code>map.centerLonLat</code> y <code>map.initialZoomLevel</code> del fichero <code>portal.properties</code>, por lo que nuestro servlet deberá modificar ese fichero con las coordenadas enviadas desde el navegador.</p>
<h2 id="creando-el-proyecto">Creando el proyecto</h2>
<p>En primer lugar, volvemos a crear un esqueleto para nuestro plugin:</p>
<div class="codehilite"><pre><span></span>$ mvn archetype:generate -DgroupId<span class="o">=</span>org.fao.unredd -DartifactId<span class="o">=</span>guardar-centro -DarchetypeArtifactId<span class="o">=</span>maven-archetype-quickstart -DinteractiveMode<span class="o">=</span><span class="nb">false</span>
</pre></div>


<p>Volvemos a añadir las dependencias necesarias para los servlets y para trabajar con la configuración de Geoladris:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;project</span> <span class="err">...</span><span class="nt">&gt;</span>
  ...
  <span class="nt">&lt;dependencies&gt;</span>
    ...
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>3.0.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.github.geoladris<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>7.0.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</pre></div>


<p>y configuramos nuestro fichero <code>src/main/resources/META-INF/web-fragment.xml</code>:</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;web-fragment</span> <span class="na">version=</span><span class="s">&quot;3.0&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-fragment_3_0.xsd&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;servlet&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>guardar-centro-servlet<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;servlet-class&gt;</span>org.fao.unredd.GuardarCentroServlet<span class="nt">&lt;/servlet-class&gt;</span>
  <span class="nt">&lt;/servlet&gt;</span>
  <span class="nt">&lt;servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>guardar-centro-servlet<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/guardar-centro<span class="nt">&lt;/url-pattern&gt;</span>
  <span class="nt">&lt;/servlet-mapping&gt;</span>
<span class="nt">&lt;/web-fragment&gt;</span>
</pre></div>


<h2 id="creando-el-servlet">Creando el servlet</h2>
<p>Ahora, deberemos implementar el servlet. Para ello, primero debemos obtener una referencia al fichero <code>portal.properties</code>, que está dentro del directorio de configuración.</p>
<p>Para esto, existe un objeto <code>Config</code>, que se puede obtener en los servlets de la siguiente manera:</p>
<div class="codehilite"><pre><span></span><span class="n">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="o">(</span><span class="n">Config</span><span class="o">)</span> <span class="n">getServletContext</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">Geoladris</span><span class="o">.</span><span class="na">ATTR_CONFIG</span><span class="o">);</span>
</pre></div>


<p>y que nos permite obtener el directorio de configuración y, por tanto, el fichero <code>portal.properties</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">File</span> <span class="n">propertiesFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getDir</span><span class="o">(),</span> <span class="s">&quot;portal.properties&quot;</span><span class="o">);</span>
</pre></div>


<p>Una vez tenemos el fichero, cargaremos todas las propiedades en un objeto <code>Properties</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
<span class="n">InputStream</span> <span class="n">inStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">propertiesFile</span><span class="o">);</span>
<span class="n">properties</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">inStream</span><span class="o">);</span>
<span class="n">inStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</pre></div>


<p>modificaremos las propiedades a partir de los parámetros enviados:</p>
<div class="codehilite"><pre><span></span><span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;map.centerLonLat&quot;</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;lon&quot;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;lat&quot;</span><span class="o">));</span>
<span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;map.initialZoomLevel&quot;</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;zoomLevel&quot;</span><span class="o">));</span>
</pre></div>


<p>y guardaremos los cambios en el fichero:</p>
<div class="codehilite"><pre><span></span><span class="n">OutputStream</span> <span class="n">outStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">propertiesFile</span><span class="o">);</span>
<span class="n">properties</span><span class="o">.</span><span class="na">store</span><span class="o">(</span><span class="n">outStream</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="n">outStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</pre></div>


<p>Aquí se puede ver el servlet completo:</p>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">org.fao.unredd</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServlet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geoladris.Geoladris</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geoladris.config.Config</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuardarCentroServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="o">(</span><span class="n">Config</span><span class="o">)</span> <span class="n">getServletContext</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">Geoladris</span><span class="o">.</span><span class="na">ATTR_CONFIG</span><span class="o">);</span>
    <span class="n">File</span> <span class="n">propertiesFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getDir</span><span class="o">(),</span> <span class="s">&quot;portal.properties&quot;</span><span class="o">);</span>

    <span class="n">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
    <span class="n">InputStream</span> <span class="n">inStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">propertiesFile</span><span class="o">);</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">inStream</span><span class="o">);</span>
    <span class="n">inStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;map.centerLonLat&quot;</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;lon&quot;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;lat&quot;</span><span class="o">));</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;map.initialZoomLevel&quot;</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;zoomLevel&quot;</span><span class="o">));</span>

    <span class="n">OutputStream</span> <span class="n">outStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">propertiesFile</span><span class="o">);</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">store</span><span class="o">(</span><span class="n">outStream</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">outStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Ahora, para probarlo tendremos que crear un plugin cliente con un botón que ,cuando se pulse, llame al servlet que acabamos de crear enviando el centro del mapa en ese momento. Bastará crear un nuevo plugin con el siguiente módulo (para más detalles ver apartados sobre <a href="../../client/hello_world/">cliente</a>):</p>
<div class="codehilite"><pre><span></span><span class="nx">define</span><span class="p">([</span> <span class="s2">&quot;message-bus&quot;</span><span class="p">,</span> <span class="s2">&quot;botonera/crear&quot;</span><span class="p">,</span> <span class="s2">&quot;ol2/map&quot;</span> <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bus</span><span class="p">,</span> <span class="nx">botonera</span><span class="p">,</span> <span class="nx">olmap</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">botonera</span><span class="p">(</span><span class="s2">&quot;guardar centro&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">olmap</span><span class="p">.</span><span class="nx">getMap</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">center</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">getCenter</span><span class="p">();</span>
    <span class="nx">center</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">(</span><span class="s2">&quot;EPSG:900913&quot;</span><span class="p">),</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">(</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">zoomLevel</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">getZoom</span><span class="p">();</span>
    <span class="nx">bus</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;ajax&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">url</span> <span class="o">:</span> <span class="s2">&quot;guardar-centro?lon=&quot;</span> <span class="o">+</span> <span class="nx">center</span><span class="p">.</span><span class="nx">lon</span> <span class="o">+</span> <span class="s2">&quot;&amp;lat=&quot;</span> <span class="o">+</span> <span class="nx">center</span><span class="p">.</span><span class="nx">lat</span> <span class="o">+</span> <span class="s2">&quot;&amp;zoomLevel=&quot;</span> <span class="o">+</span> <span class="nx">zoomLevel</span><span class="p">,</span>
      <span class="nx">success</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">indicators</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;centro guardado&quot;</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">errorMsg</span> <span class="o">:</span> <span class="s2">&quot;No se pudo guardar el centro&quot;</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>Por último, deberíamos poder instalar empaquetar nuestro plugin y reiniciar el portal para poder utilizar nuestro botón enlazado con nuestro servlet.</p>
<h2 id="manejando-errores">Manejando errores</h2>
<p>El servlet anterior parte de la base de que las peticiones que se hagan van a ser satisfactorias, se va a guardar el centro. Pero en la realidad esto no es la norma general. ¿Qué sucede si la petición no incluye los parámetros <code>lon</code>, <code>lat</code>, o <code>zoomLevel</code>? ¿Qué pasa si el fichero <code>portal.properties</code> ha sido eliminado?</p>
<p>El estándar HTML define una serie de códigos que pueden ayudar en la comunicación de estas condiciones excepcionales:</p>
<ul>
<li><code>Ok (200)</code>: Ejecución satisfactoria.</li>
<li><code>Bad Request (400)</code>: La petición no pudo ser entendida por el servidor. Aquí se puede indicar que no fue especificado el parámetro. Es posible acompañar el código con un mensaje descriptivo.</li>
<li><code>Internal server error (500)</code>: Adecuado para indicar errores graves, irrecuperables, como un bug en el código o que el fichero <code>portal.properties</code>.</li>
</ul>
<p>Para utilizar estos errores, basta con utilizar el método <a href="https://javaee.github.io/javaee-spec/javadocs/javax/servlet/http/HttpServletResponse.html#sendError-int-">HttpServletResponse.sendError</a>:</p>
<p>Por ejemplo, en caso de que se desee enviar un código <code>Bad Request (400)</code> cuando el parámetro <code>lon</code> no esté presente:</p>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="o">(</span><span class="n">lon</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">resp</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_BAD_REQUEST</span><span class="o">);</span>
  <span class="k">return</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>


<p>Teniendo esto en cuenta, el servlet se podría escribir así:</p>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">org.fao.unredd</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServlet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geoladris.Geoladris</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geoladris.config.Config</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuardarCentroServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="o">(</span><span class="n">Config</span><span class="o">)</span> <span class="n">getServletContext</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">Geoladris</span><span class="o">.</span><span class="na">ATTR_CONFIG</span><span class="o">);</span>
    <span class="n">File</span> <span class="n">propertiesFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getDir</span><span class="o">(),</span> <span class="s">&quot;portal.properties&quot;</span><span class="o">);</span>
    <span class="n">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;lon&quot;</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;lat&quot;</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">zoomLevel</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;zoomLevel&quot;</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">lon</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">lat</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">zoomLevel</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">resp</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_BAD_REQUEST</span><span class="o">,</span> <span class="s">&quot;Los parámetros lon, lat y zoomLevel son obligatorios.&quot;</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Lectura del fichero</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">FileInputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">propertiesFile</span><span class="o">);</span>
      <span class="n">properties</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
      <span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">resp</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_INTERNAL_SERVER_ERROR</span><span class="o">,</span> <span class="s">&quot;Error grave en el servidor. Contacte al administrador&quot;</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;map.centerLonLat&quot;</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;lon&quot;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;lat&quot;</span><span class="o">));</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;map.initialZoomLevel&quot;</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;zoomLevel&quot;</span><span class="o">));</span>

    <span class="c1">// Escritura del fichero</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">FileOutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">propertiesFile</span><span class="o">);</span>
      <span class="n">properties</span><span class="o">.</span><span class="na">store</span><span class="o">(</span><span class="n">outputStream</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
      <span class="n">outputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">resp</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_INTERNAL_SERVER_ERROR</span><span class="o">,</span> <span class="s">&quot;Error grave en el servidor. Contacte al administrador&quot;</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../hello_world/" title="Hola mundo" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Hola mundo
              </span>
            </div>
          </a>
        
        
          <a href="../db_servlet/" title="Servlet de acceso a base de datos" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Servlet de acceso a base de datos
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-07b0fbb49b.js"></script>
      
      
      <script>app.initialize({url:{base:"../.."}})</script>
      
        <script src="../../static/exercises/filter.js"></script>
      
        <script src="../../static/exercises/map-scale.js"></script>
      
        <script src="../../static/exercises/measure.js"></script>
      
        <script src="../../static/exercises/new-group-layer.js"></script>
      
        <script src="../../static/exercises/temperature.js"></script>
      
        <script src="../../static/exercises/wfs-query.js"></script>
      
        <script src="../../static/exercises/zoom-panel-install-button.js"></script>
      
        <script src="../../static/exercises/zoom-panel.js"></script>
      
        <script src="../../static/exercises/zoomto.js"></script>
      
    
    
      
    
  </body>
</html>